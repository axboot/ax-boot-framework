"use strict";!function(){var t=ax5.ui,e=ax5.util,i=void 0;t.addClass({className:"uploader"},function(){var o=function(){var o=this,s=void 0;this.instanceId=ax5.getGuid(),this.config={clickEventName:"click",theme:"default",lang:{upload:"Upload",abort:"Abort"},uploadedBox:{columnKeys:{name:"name",type:"type",size:"size",uploadedName:"uploadedName",uploadedPath:"uploadedPath",downloadPath:"downloadPath",previewPath:"previewPath",thumbnail:"thumbnail"}},animateTime:100,accept:"*/*",multiple:!1,manualUpload:!1,progressBox:!0},this.defaultBtns={upload:{label:this.config.lang.upload,theme:"btn-primary"},abort:{label:this.config.lang.abort,theme:this.config.theme}},this.uploadedFiles=[],this.$target=null,this.$inputContainer=null,this.$inputFile=null,this.$inputFileForm=null,this.$fileSelector=null,this.$dropZone=null,this.$uploadedBox=null,this.__uploading=!1,this.selectedFiles=[],this.selectedFilesTotal=0,this.__loaded=0,s=this.config;var n=function(t){return s.onStateChanged?s.onStateChanged.call(t,t):this.onStateChanged&&this.onStateChanged.call(t,t),t=null,!0}.bind(this),r=function(t){var i=void 0;return ax5.info.supportFileApi?"dataTransfer"in t?i=t.dataTransfer.files:"target"in t?i=t.target.files:t&&(i=t):i={path:t.target.value},!!i&&(length in i?1==i.length?this.selectedFiles=[i[0]]:this.selectedFiles=e.toArray(i):this.selectedFiles=[i],s.progressBox&&p(),s.manualUpload||this.send(),void(ax5.info.supportFileApi||l(!1)))}.bind(this),a=function(){this.$fileSelector.off("click.ax5uploader").on("click.ax5uploader",function(){this.$inputFile.trigger("click")}.bind(this)),ax5.info.supportFileApi||(this.$fileSelector.off("mouseover.ax5uploader").on("mouseover.ax5uploader",function(){l(!0)}.bind(this)),this.$inputFile.off("mouseover.ax5uploader").on("mouseover.ax5uploader",function(){this.$fileSelector.addClass("active")}.bind(this)),this.$inputFile.off("mouseout.ax5uploader").on("mouseout.ax5uploader",function(){this.$fileSelector.removeClass("active"),l(!1)}.bind(this))),function(){return!(!this.$uploadedBox||!this.$uploadedBox.get(0))&&(this.$uploadedBox.on("click","[data-uploaded-item-cell]",function(){var t=jQuery(this),e=t.attr("data-uploaded-item-cell"),i=Number(t.parents("[data-ax5uploader-uploaded-item]").attr("data-ax5uploader-uploaded-item")),n={};s.uploadedBox&&s.uploadedBox.onclick&&(n={self:o,cellType:e,uploadedFiles:o.uploadedFiles,fileIndex:i},s.uploadedBox.onclick.call(n,n)),t=null,e=null,i=null,n=null}),void this.$uploadedBox.on("dragstart",function(t){return e.stopEvent(t),!1}))}.call(this),function(){if(!ax5.info.supportFileApi)return!1;if(!this.$dropZone||!this.$dropZone.get(0))return!1;this.$dropZone.parent().on("click","[data-ax5uploader-dropzone]",function(t){var i=jQuery(t.target);0!=i.parents("[data-ax5uploader-uploaded-item]").length||i.attr("data-ax5uploader-uploaded-item")||(this==t.target||$.contains(this,t.target))&&(e.isFunction(s.dropZone.onclick)?s.dropZone.onclick.call({self:o}):o.$inputFile.trigger("click"))}),this.$dropZone.get(0).addEventListener("dragover",function(t){e.stopEvent(t),e.isFunction(s.dropZone.ondragover)?s.dropZone.ondragover.call({self:o}):o.$dropZone.addClass("dragover")},!1),this.$dropZone.get(0).addEventListener("dragleave",function(t){e.stopEvent(t),e.isFunction(s.dropZone.ondragover)?s.dropZone.ondragout.call({self:o}):o.$dropZone.removeClass("dragover")},!1),this.$dropZone.get(0).addEventListener("drop",function(t){e.stopEvent(t),e.isFunction(s.dropZone.ondrop)?s.dropZone.ondrop.call({self:o}):o.$dropZone.removeClass("dragover"),r(t||window.event)},!1)}.call(this)}.bind(this),l=function(t){if(t){if(!ax5.info.supportFileApi){var e=this.$fileSelector.offset();e.width=this.$fileSelector.outerWidth(),e.height=this.$fileSelector.outerHeight(),this.$inputFile.css(e)}}else this.$inputFile.css({left:-1e3,top:-1e3})}.bind(this),d=function(t){var e=function(){var e=jQuery(window),i=jQuery(document.body),o={},n=6,r={},a={},l=void 0;o=this.$progressBox.parent().get(0)==this.$target.get(0)?this.$fileSelector.position():this.$fileSelector.offset(),r={width:this.$fileSelector.outerWidth(),height:this.$fileSelector.outerHeight()},a={winWidth:Math.max(e.width(),i.width()),winHeight:Math.max(e.height(),i.height()),width:this.$progressBox.outerWidth(),height:this.$progressBox.outerHeight()},s.progressBoxDirection&&""!==s.progressBoxDirection&&"auto"!==s.progressBoxDirection?l=s.progressBoxDirection:(l="top",o.top-a.height-n<0?l="top":o.top+r.height+a.height+n>a.winHeight&&(l="bottom")),t&&this.$progressBox.addClass("direction-"+l);var d=function(){var t={left:0,top:0};switch(l){case"top":t.left=o.left+r.width/2-a.width/2,t.top=o.top+r.height+n;break;case"bottom":t.left=o.left+r.width/2-a.width/2,t.top=o.top-a.height-n;break;case"left":t.left=o.left+r.width+n,t.top=o.top-a.height/2+r.height/2;break;case"right":t.left=o.left-a.width-n,t.top=o.top-a.height/2+r.height/2}return t}();(function(){"top"!=l&&"bottom"!=l||(d.left<0?(d.left=n,this.$progressBoxArrow.css({left:o.left+r.width/2-d.left})):d.left+a.width>a.winWidth&&(d.left=a.winWidth-a.width-n,this.$progressBoxArrow.css({left:o.left+r.width/2-d.left})))}).call(this),this.$progressBox.css(d)};this.$progressBox.css({top:-999}),t&&(function(){return s.viewport?jQuery(s.viewport.selector):this.$target}.call(this).append(this.$progressBox),this.$progressBox.off("click.ax5uploader").on("click.ax5uploader","button",function(t){var e=t.target.getAttribute("data-pregressbox-btn"),i={upload:function(){this.send()},abort:function(){this.abort()}};i[e]&&i[e].call(this)}.bind(this))),setTimeout(function(){e.call(this)}.bind(this))}.bind(this),p=function(){this.$progressBox.removeClass("destroy"),this.$progressUpload.removeAttr("disabled"),this.$progressAbort.removeAttr("disabled"),d("append"),n({self:this,state:"open"})}.bind(this),u=function(){this.$progressBox.addClass("destroy"),setTimeout(function(){this.$progressBox.remove()}.bind(this),s.animateTime)}.bind(this),h=function(){var t={html5:function(){var t=this.selectedFiles.shift();if(!t)return g(),this;t[0]&&(t=t[0]);var i=new FormData;this.$target.find("input").each(function(){i.append(this.name,this.value)}),i.append(s.form.fileName,t),this.xhr=new XMLHttpRequest,this.xhr.open("post",s.form.action,!0),this.xhr.onload=function(t){var i=t.target.response;try{"string"==typeof i&&(i=e.parseJson(i))}catch(t){return!1}return s.debug&&console.log(i),i.error?(s.debug&&console.log(i.error),e.isFunction(s.onuploaderror)&&s.onuploaderror.call({self:this,error:i.error},i),o.send(),!1):(f(i),void o.send())},this.xhr.upload.onprogress=function(t){c(t),e.isFunction(s.onprogress)&&s.onprogress.call({loaded:t.loaded,total:t.total},t)},this.xhr.send(i)},form:function(){this.__uploading=!0;var t=jQuery('<iframe src="javascript:false;" name="ax5uploader-'+this.instanceId+'-iframe" style="display:none;"></iframe>');jQuery(document.body).append(t),t.load(function(){var e=this.contentWindow?this.contentWindow.document:this.contentDocument?this.contentDocument:this.document,i=e.documentElement?e.documentElement:e.body,o=i.textContent?i.textContent:i.innerText,n=void 0;try{n=JSON.parse(o)}catch(t){n={error:"Syntax error",body:o}}s.debug&&console.log(n),n.error?console.log(n):(f(n),t.remove(),setTimeout(function(){g()},300))}),this.$inputFileForm.attr("target","ax5uploader-"+this.instanceId+"-iframe").attr("action",s.form.action).submit(),this.selectedFilesTotal=1,c({loaded:1,total:1})}};if(this.__uploading===!1){var i=0;this.selectedFiles.forEach(function(t){i+=t.size}),this.selectedFilesTotal=i,this.__loaded=0,this.__uploading=!0,this.$progressUpload.attr("disabled","disabled"),this.$progressAbort.removeAttr("disabled")}t[ax5.info.supportFileApi?"html5":"form"].call(this)}.bind(this),c=function(t){this.__loaded+=t.loaded,this.$progressBar.css({width:e.number(this.__loaded/this.selectedFilesTotal*100,{round:2})+"%"}),t.lengthComputable&&t.loaded>=t.total}.bind(this),f=function(t){s.debug&&console.log(t),this.uploadedFiles.push(t),x(),e.isFunction(s.onuploaded)&&s.onuploaded.call({self:this},t)}.bind(this),g=function(){this.__uploading=!1,this.$progressUpload.removeAttr("disabled"),this.$progressAbort.attr("disabled","disabled"),s.progressBox&&u(),e.isFunction(s.onuploadComplete)&&s.onuploadComplete.call({self:this}),b()}.bind(this),m=function(){var t={html5:function(){this.xhr&&this.xhr.abort()},form:function(){}};this.__uploading=!1,this.$progressUpload.removeAttr("disabled"),this.$progressAbort.attr("disabled","disabled"),t[ax5.info.supportFileApi?"html5":"form"].call(this),s.progressBox&&u(),b(),s.debug&&console.log("cancelUpload")}.bind(this),x=function(){return null===this.$uploadedBox?this:(this.$uploadedBox.html(i.tmpl.get("upoadedBox",{uploadedFiles:this.uploadedFiles,icon:s.uploadedBox.icon,lang:s.uploadedBox.lang,supportFileApi:!!ax5.info.supportFileApi},s.uploadedBox.columnKeys)),void this.$uploadedBox.find("img").on("error",function(){$(this).parent().addClass("no-image")}))}.bind(this),b=function(){this.$inputFile&&this.$inputFile.get(0)&&this.$inputFile.remove(),this.$inputFileForm&&this.$inputFileForm.get(0)&&this.$inputFileForm.remove(),this.$inputFile=jQuery(i.tmpl.get.call(this,"inputFile",{instanceId:this.instanceId,multiple:s.multiple,accept:s.accept,name:s.form.fileName})),ax5.info.supportFileApi?jQuery(document.body).append(this.$inputFile):(this.$fileSelector.attr("tabindex",-1),this.$inputFileForm=jQuery(i.tmpl.get.call(this,"inputFileForm",{instanceId:this.instanceId})),this.$inputFileForm.append(this.$inputFile),jQuery(document.body).append(this.$inputFileForm)),this.$inputFile.off("change.ax5uploader").on("change.ax5uploader",function(t){r(t)}.bind(this))}.bind(this);this.init=function(t){return s=jQuery.extend(!0,{},s,t),s.target?(this.$target=jQuery(s.target),s.dropZone&&s.dropZone.target&&ax5.info.supportFileApi&&(this.$dropZone=jQuery(s.dropZone.target),this.$dropZone.attr("data-ax5uploader-dropzone",this.instanceId)),s.uploadedBox&&s.uploadedBox.target&&(this.$uploadedBox=jQuery(s.uploadedBox.target)),function(t){e.isObject(t)&&!t.error&&(s=jQuery.extend(!0,s,t))}.call(this,e.parseJson(this.$target.attr("data-ax5uploader-config"),!0)),this.$fileSelector=this.$target.find('[data-ax5uploader-button="selector"]'),0===this.$fileSelector.length?(console.log(ax5.info.getError("ax5uploader","402","can not find file selector")),this):(b(),s.btns=jQuery.extend({},this.defaultBtns,s.btns),this.$progressBox=jQuery(i.tmpl.get.call(this,"progressBox",{instanceId:this.instanceId,btns:s.btns})),this.$progressBar=this.$progressBox.find('[role="progressbar"]'),this.$progressBoxArrow=this.$progressBox.find(".ax-progressbox-arrow"),this.$progressUpload=this.$progressBox.find('[data-pregressbox-btn="upload"]'),this.$progressAbort=this.$progressBox.find('[data-pregressbox-btn="abort"]'),ax5.info.supportFileApi||this.$progressAbort.hide(),a(),x(),this)):(console.log(ax5.info.getError("ax5uploader","401","init")),this)},this.send=function(){return function(){if(e.isFunction(s.validateSelectedFiles)){var t={self:this,uploadedFiles:this.uploadedFiles,selectedFiles:this.selectedFiles};if(!s.validateSelectedFiles.call(t,t))return m(),!1}return h(),this}}(),this.abort=function(){return function(){return ax5.info.supportFileApi?(m(),this):(alert("This browser not supported abort method"),this)}}(),this.setUploadedFiles=function(t){if(e.isArray(t)&&(this.uploadedFiles=t),e.isString(t))try{this.uploadedFiles=JSON.parse(t)}catch(t){}return x(),this},this.clear=function(){return this.setUploadedFiles([]),this},this.removeFile=function(t){return isNaN(Number(t))||this.uploadedFiles.splice(t,1),x(),this},this.removeFileAll=function(){return this.uploadedFiles=[],x(),this},this.selectFile=function(){return!!ax5.info.supportFileApi&&(this.$inputFile.trigger("click"),!0)},this.main=function(){t.uploader_instance=t.uploader_instance||[],t.uploader_instance.push(this),arguments&&e.isObject(arguments[0])&&this.setConfig(arguments[0])}.apply(this,arguments)};return o}()),i=ax5.ui.uploader}(),function(){var t=ax5.ui.uploader,e=function(t){return"\n        "},i=function(t){return'<input type="file" data-ax5uploader-input="{{instanceId}}" name="{{name}}" {{#multiple}}multiple{{/multiple}} accept="{{accept}}" />'},o=function(t){return'<form data-ax5uploader-form="{{instanceId}}" name="ax5uploader-{{instanceId}}-form" method="post" enctype="multipart/form-data"></form>'},s=function(t){return'\n<div data-ax5uploader-progressbox="{{instanceId}}" class="{{theme}}">\n    <div class="ax-progressbox-body">\n        <div class="ax-pregressbox-content">\n            <div class="progress">\n              <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0">\n                <span class="sr-only">0% Complete</span>\n              </div>\n            </div>\n        </div>\n        {{#btns}}\n            <div class="ax-progressbox-buttons">\n            {{#btns}}\n                {{#@each}}\n                <button data-pregressbox-btn="{{@key}}" class="btn btn-default {{@value.theme}}">{{@value.label}}</button>\n                {{/@each}}\n            {{/btns}}\n            </div>\n        {{/btns}}\n    </div>\n    <div class="ax-progressbox-arrow"></div>\n</div>\n'},n=function(t){return'\n{{#uploadedFiles}}<div data-ax5uploader-uploaded-item="{{@i}}">\n    <div class="uploaded-item-preview">\n        {{#'+t.thumbnail+'}}<img src="'+t.apiServerUrl+"{{"+t.thumbnail+'}}">{{/'+t.thumbnail+'}}\n    </div>\n    <div class="uploaded-item-holder">\n        <div class="uploaded-item-cell" data-uploaded-item-cell="download">{{{icon.download}}}</div>\n        <div class="uploaded-item-cell" data-uploaded-item-cell="filename">{{'+t.name+'}}</div>\n        <div class="uploaded-item-cell" data-uploaded-item-cell="filesize">({{#@fn_get_byte}}{{'+t.size+'}}{{/@fn_get_byte}})</div>\n        <div class="uploaded-item-cell" data-uploaded-item-cell="delete">{{{icon.delete}}}</div>\n    </div>\n</div>{{/uploadedFiles}}\n{{^uploadedFiles}}\n{{#supportFileApi}}{{{lang.supportedHTML5_emptyListMsg}}}{{/supportFileApi}}\n{{^supportFileApi}}{{{lang.emptyListMsg}}}{{/supportFileApi}}\n{{/uploadedFiles}}\n'};t.tmpl={uploadProgress:e,inputFile:i,inputFileForm:o,progressBox:s,upoadedBox:n,get:function(e,i,o){return i["@fn_get_byte"]=function(){return function(t,e){return ax5.util.number(e(t),{round:2,byte:!0})}},ax5.mustache.render(t.tmpl[e].call(this,o),i)}}}();
//# sourceMappingURL=ax5uploader.min.js.map
